# Deployment Guide - AI Academic Advisor

## Table of Contents
1. [Local Development](#local-development)
2. [Docker Deployment](#docker-deployment)
3. [Railway Deployment](#railway-deployment)
4. [Heroku Deployment](#heroku-deployment)
5. [AWS Deployment](#aws-deployment)
6. [Database Setup](#database-setup)
7. [Environment Variables](#environment-variables)
8. [Monitoring](#monitoring)

---

## Local Development

### Prerequisites
- Python 3.8+
- PostgreSQL (optional, SQLite works for development)
- OpenAI API Key (optional)

### Setup Steps

1. **Clone Repository**
```bash
git clone <repository-url>
cd AI-Advisor
```

2. **Create Virtual Environment**
```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. **Install Dependencies**
```bash
pip install -r requirement.txt
pip install -r backend/requirements.txt
```

4. **Set Environment Variables**
```bash
cp backend/.env.example backend/.env
# Edit backend/.env with your settings
```

5. **Run Database Migrations**
```bash
cd backend
alembic upgrade head
```

6. **Seed Database**
```bash
python backend/seed_data.py
```

7. **Start Backend**
```bash
cd backend
python main.py
# Or: uvicorn main:app --reload
```

8. **Start Frontend (New Terminal)**
```bash
streamlit run app.py
```

9. **Access Application**
- Frontend: http://localhost:8501
- Backend API: http://localhost:8000
- API Docs: http://localhost:8000/api/docs

---

## Docker Deployment

### Single Command Deploy

```bash
docker-compose up -d
```

### Services
- **PostgreSQL**: localhost:5432
- **Backend API**: localhost:8000
- **Frontend**: localhost:8501

### Environment Setup

Create `.env` file:
```env
POSTGRES_PASSWORD=your_secure_password
SECRET_KEY=your-secret-key-minimum-32-characters
OPENAI_API_KEY=sk-your-openai-key
```

### Commands

```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs -f

# Stop all services
docker-compose down

# Rebuild after code changes
docker-compose up -d --build

# Run migrations
docker-compose exec backend alembic upgrade head

# Access database
docker-compose exec postgres psql -U harbour_user -d harbour_advisor
```

---

## Railway Deployment

### One-Click Deploy

[![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/new)

### Manual Setup

1. **Create Railway Account**
   - Visit https://railway.app
   - Sign up with GitHub

2. **Create New Project**
   - Click "New Project"
   - Select "Deploy from GitHub repo"
   - Connect your repository

3. **Add PostgreSQL Database**
   - Click "New Service"
   - Select "Database" > "PostgreSQL"
   - Railway auto-generates connection string

4. **Configure Environment Variables**
```
DATABASE_URL=<auto-generated-by-railway>
SECRET_KEY=your-secret-key-here
OPENAI_API_KEY=sk-your-key-here
ALLOWED_ORIGINS=https://your-app.railway.app
```

5. **Deploy**
   - Railway automatically deploys on git push
   - Access via: https://your-app.railway.app

### Railway Configuration

File: `railway.json` (already created)

```json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "uvicorn backend.main:app --host 0.0.0.0 --port $PORT"
  }
}
```

---

## Heroku Deployment

### Prerequisites
- Heroku Account
- Heroku CLI installed

### Deployment Steps

1. **Login to Heroku**
```bash
heroku login
```

2. **Create App**
```bash
heroku create your-app-name
```

3. **Add PostgreSQL**
```bash
heroku addons:create heroku-postgresql:mini
```

4. **Set Environment Variables**
```bash
heroku config:set SECRET_KEY=your-secret-key
heroku config:set OPENAI_API_KEY=sk-your-key
heroku config:set ALLOWED_ORIGINS=https://your-app-name.herokuapp.com
```

5. **Deploy**
```bash
git push heroku main
```

6. **Run Migrations**
```bash
heroku run alembic -c backend/alembic.ini upgrade head
```

7. **Access App**
```bash
heroku open
```

### Procfile

File: `Procfile` (already created)

```
web: uvicorn backend.main:app --host 0.0.0.0 --port $PORT
release: alembic -c backend/alembic.ini upgrade head
```

---

## AWS Deployment

### Using AWS EC2

1. **Launch EC2 Instance**
   - AMI: Ubuntu 22.04 LTS
   - Instance Type: t3.small (minimum)
   - Security Group: Allow ports 22, 80, 443, 8000, 8501

2. **Connect to Instance**
```bash
ssh -i your-key.pem ubuntu@your-instance-ip
```

3. **Install Dependencies**
```bash
sudo apt update
sudo apt install -y python3-pip python3-venv nginx
```

4. **Clone and Setup**
```bash
git clone <your-repo>
cd AI-Advisor
python3 -m venv venv
source venv/bin/activate
pip install -r requirement.txt
pip install -r backend/requirements.txt
```

5. **Setup PostgreSQL**
```bash
sudo apt install -y postgresql postgresql-contrib
sudo -u postgres createdb harbour_advisor
```

6. **Configure Environment**
```bash
cp backend/.env.example backend/.env
nano backend/.env  # Edit with your settings
```

7. **Setup Systemd Service**

Create `/etc/systemd/system/harbour-backend.service`:
```ini
[Unit]
Description=Harbour Space AI Advisor Backend
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/AI-Advisor
Environment="PATH=/home/ubuntu/AI-Advisor/venv/bin"
ExecStart=/home/ubuntu/AI-Advisor/venv/bin/uvicorn backend.main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
```

8. **Start Service**
```bash
sudo systemctl daemon-reload
sudo systemctl enable harbour-backend
sudo systemctl start harbour-backend
```

9. **Configure Nginx**

Create `/etc/nginx/sites-available/harbour`:
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8501;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

10. **Enable Site**
```bash
sudo ln -s /etc/nginx/sites-available/harbour /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## Database Setup

### PostgreSQL Setup

1. **Install PostgreSQL**
```bash
# Ubuntu/Debian
sudo apt install postgresql postgresql-contrib

# macOS
brew install postgresql
```

2. **Create Database**
```bash
sudo -u postgres psql
CREATE DATABASE harbour_advisor;
CREATE USER harbour_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE harbour_advisor TO harbour_user;
\q
```

3. **Update Connection String**
```env
DATABASE_URL=postgresql://harbour_user:your_password@localhost:5432/harbour_advisor
```

### Run Migrations

```bash
cd backend
alembic upgrade head
```

### Create New Migration

```bash
cd backend
alembic revision --autogenerate -m "Description of changes"
alembic upgrade head
```

### Seed Data

```bash
python backend/seed_data.py
```

---

## Environment Variables

### Required Variables

```env
# Security
SECRET_KEY=your-secret-key-minimum-32-characters

# Database
DATABASE_URL=postgresql://user:password@host:5432/dbname

# CORS
ALLOWED_ORIGINS=http://localhost:8501,https://yourdomain.com

# API Settings
API_HOST=0.0.0.0
API_PORT=8000
```

### Optional Variables

```env
# OpenAI Integration
OPENAI_API_KEY=sk-your-openai-api-key

# JWT Settings
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# Logging
LOG_LEVEL=INFO
```

### Generate Secret Key

```python
import secrets
print(secrets.token_urlsafe(32))
```

---

## Monitoring

### Application Logging

Logs are automatically configured. View logs:

```bash
# Docker
docker-compose logs -f backend

# Systemd
sudo journalctl -u harbour-backend -f

# Heroku
heroku logs --tail
```

### Health Checks

```bash
# Check API health
curl http://localhost:8000/api/health

# Check database connection
curl http://localhost:8000/api/health/db
```

### Monitoring Tools

**Recommended Tools:**
- **Sentry**: Error tracking
- **DataDog**: Performance monitoring
- **Prometheus + Grafana**: Metrics and dashboards
- **UptimeRobot**: Uptime monitoring

### Setup Sentry

1. **Install**
```bash
pip install sentry-sdk[fastapi]
```

2. **Configure** (in `backend/main.py`):
```python
import sentry_sdk

sentry_sdk.init(
    dsn="your-sentry-dsn",
    environment="production"
)
```

---

## Backup Strategy

### Database Backups

**Automatic Backups (PostgreSQL):**
```bash
# Create backup
pg_dump -U harbour_user harbour_advisor > backup.sql

# Restore backup
psql -U harbour_user harbour_advisor < backup.sql
```

**Automated Daily Backups:**
Add to crontab:
```
0 2 * * * pg_dump -U harbour_user harbour_advisor > /backups/db_$(date +\%Y\%m\%d).sql
```

---

## SSL/HTTPS Setup

### Using Let's Encrypt (Free)

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

---

## Troubleshooting

### Common Issues

**Database Connection Error:**
- Check DATABASE_URL format
- Verify PostgreSQL is running
- Check firewall rules

**API Not Starting:**
- Check port availability
- Review logs for errors
- Verify all dependencies installed

**Migration Errors:**
- Ensure database is accessible
- Check alembic.ini configuration
- Run `alembic current` to check status

### Support

For deployment issues, check:
- Application logs
- Database logs
- System logs
- Network configuration

---

## Production Checklist

- [ ] Set strong SECRET_KEY
- [ ] Configure DATABASE_URL (PostgreSQL)
- [ ] Set ALLOWED_ORIGINS properly
- [ ] Enable HTTPS
- [ ] Set up database backups
- [ ] Configure monitoring
- [ ] Set up error tracking (Sentry)
- [ ] Review security settings
- [ ] Test all endpoints
- [ ] Load test application
- [ ] Document runbook procedures

---

## Next Steps

After deployment:
1. Test all features
2. Monitor performance
3. Set up alerts
4. Plan scaling strategy
5. Regular security updates

For questions or issues, refer to the main README.md or open an issue on GitHub.
